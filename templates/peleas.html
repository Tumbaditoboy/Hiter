<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Peleas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
      .fighter-card {
        background-color: #2C2E39;
        border-radius: 12px;
        color: #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        transition: transform 0.2s;
        height: 100%;
        position: relative;
        overflow: hidden;
      }
      .fighter-card:hover { transform: translateY(-5px); }

      .fighter-header {
        display: flex;
        align-items: center;
        padding: 15px;
        gap: 12px;
      }

      .avatar-container {
        width: 70px;
        height: 70px;
        background-color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        flex-shrink: 0;
      }
      .avatar-img { width: 100%; height: 100%; object-fit: cover; }
      .avatar-placeholder { font-size: 36px; color: #2C2E39; }

      .fighter-info {
        flex-grow: 1;
        line-height: 1.2;
      }

      .fighter-alias {
        color: #fff;
        font-weight: 900;
        font-size: 1.2rem;
        text-transform: uppercase;
        margin: 0;
        font-family: sans-serif;
      }

      .fighter-name {
        color: #ddd;
        font-weight: 700;
        font-size: 1rem;
        text-transform: uppercase;
        margin: 0;
      }

      .fighter-meta {
        color: #ccc;
        font-weight: bold;
        font-size: 0.9rem;
        margin-top: 2px;
      }

      .fighter-body {
        padding: 0 15px 15px 15px;
        font-size: 0.95rem;
        color: #eee;
      }

      .vs-badge {
        background: #d67c7f;
        color: #000;
        font-weight: 900;
        padding: 6px 10px;
        border-radius: 8px;
        text-transform: uppercase;
        margin: 0 6px;
      }

      .card-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        padding: 2px 8px;
        z-index: 10;
      }
      .btn-icon {
        border: none;
        background: transparent;
        color: #fff;
        padding: 0 5px;
        transition: all 0.2s;
      }
      .btn-icon:hover { transform: scale(1.1); }
      .btn-icon.delete:hover { color: #dc3545; }
    </style>
  </head>

  <body class="p-4 bg-dark">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4 text-white">
        <h1 class="h3">Peleas</h1>
        <button class="btn btn-warning fw-bold" onclick="openAddModal()">
          <i class="bi bi-plus-lg"></i> Agregar Pelea
        </button>
      </div>

      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for p in peleas %}
          {% set peleador1 = peleadores | selectattr("id","eq", p.peleador1_id) | first %}
          {% set peleador2 = peleadores | selectattr("id","eq", p.peleador2_id) | first %}
          {% set ganador = peleadores | selectattr("id","eq", p.ganador) | first %}

          <div class="col">
            <div class="fighter-card fight-item"
                 data-id="{{ p.id }}"
                 data-peleador1="{{ p.peleador1_id }}"
                 data-peleador2="{{ p.peleador2_id }}"
                 data-fecha="{{ p.fecha }}"
                 data-ubicacion="{{ p.ubicacion }}"
                 data-estado="{{ p.estado }}"
                 data-ganador="{{ p.ganador }}">
              
              <div class="card-actions">
                <button class="btn-icon" onclick="openEditModal('{{ p.id }}')" title="Editar">
                  <i class="bi bi-pencil-fill"></i>
                </button>
                <button class="btn-icon delete" onclick="deletePelea('{{ p.id }}')" title="Eliminar">
                  <i class="bi bi-trash-fill"></i>
                </button>
              </div>

              <!-- Header: avatar + alias + nombre (mismo orden visual que peleadores) -->
              <div class="fighter-header">
                <div class="avatar-container">
                  {% if peleador1 and peleador1.foto %}
                    <img src="{{ peleador1.foto }}" alt="foto peleador 1" class="avatar-img">
                  {% else %}
                    <i class="bi bi-person-fill avatar-placeholder"></i>
                  {% endif %}
                </div>
                <div class="fighter-info">
                  <p class="fighter-alias">{{ peleador1.alias if peleador1 else 'N/A' }}</p>
                  <p class="fighter-name">{{ peleador1.nombre if peleador1 else 'Desconocido' }}</p>
                </div>

                <span class="vs-badge">VS</span>

                <div class="avatar-container">
                  {% if peleador2 and peleador2.foto %}
                    <img src="{{ peleador2.foto }}" alt="foto peleador 2" class="avatar-img">
                  {% else %}
                    <i class="bi bi-person-fill avatar-placeholder"></i>
                  {% endif %}
                </div>
                <div class="fighter-info">
                  <p class="fighter-alias">{{ peleador2.alias if peleador2 else 'N/A' }}</p>
                  <p class="fighter-name">{{ peleador2.nombre if peleador2 else 'Desconocido' }}</p>
                </div>
              </div>

              <!-- Meta al estilo peleadores -->
              <div class="fighter-body">
                <div class="fighter-meta">
                  Fecha: {{ p.fecha }} <br>
                  Ubicaci√≥n: {{ p.ubicacion }} <br>
                  Estado: {{ p.estado }}
                </div>

                <p class="m-0 text-break mt-2">
                  üèÜ Ganador: <strong>{{ ganador.alias if ganador else 'Pendiente' }}</strong>
                </p>

                <small class="text-white-50 mt-2 d-block">
                  ID: {{ p.id }}
                </small>
              </div>
            </div>
          </div>
        {% else %}
          <div class="col-12 text-center text-white">
            <p>No hay peleas registradas</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Modal: mismo flujo y orden de campos -->
    <div class="modal fade" id="peleaModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="peleaForm" onsubmit="event.preventDefault(); savePelea();">
            <div class="modal-header bg-dark text-white">
              <h5 class="modal-title" id="modalTitle">Agregar Pelea</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="peleaId" />
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Peleador 1</label>
                  <select id="peleador1" class="form-control" required>
                    <option value="">Seleccione...</option>
                    {% for pl in peleadores %}
                      <option value="{{ pl.id }}">{{ pl.alias }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Peleador 2</label>
                  <select id="peleador2" class="form-control" required>
                    <option value="">Seleccione...</option>
                    {% for pl in peleadores %}
                      <option value="{{ pl.id }}">{{ pl.alias }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Fecha</label>
                  <input type="datetime-local" id="fecha" class="form-control" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ubicaci√≥n</label>
                  <input class="form-control" id="ubicacion" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Estado</label>
                  <input class="form-control" id="estado" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ganador</label>
                  <select id="ganador" class="form-control">
                    <option value="">Seleccione...</option>
                    {% for pl in peleadores %}
                      <option value="{{ pl.id }}">{{ pl.alias }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const modalEl = document.getElementById('peleaModal');
      const modal = new bootstrap.Modal(modalEl);

      function openAddModal() {
        document.getElementById('modalTitle').textContent = 'Agregar Pelea';
        clearForm();
        modal.show();
      }

      function openEditModal(id) {
        const item = document.querySelector(`.fight-item[data-id="${id}"]`);
        if (!item) return alert('Registro no encontrado');

        document.getElementById('modalTitle').textContent = 'Editar Pelea';
        document.getElementById('peleaId').value = id;

        document.getElementById('peleador1').value = item.dataset.peleador1 || '';
        document.getElementById('peleador2').value = item.dataset.peleador2 || '';
        document.getElementById('fecha').value = (item.dataset.fecha || '').replace(' ', 'T');
        document.getElementById('ubicacion').value = item.dataset.ubicacion || '';
        document.getElementById('estado').value = item.dataset.estado || '';
        document.getElementById('ganador').value = item.dataset.ganador || '';

        modal.show();
      }

      function clearForm() {
        document.getElementById('peleaId').value = '';
        document.getElementById('peleador1').value = '';
        document.getElementById('peleador2').value = '';
        document.getElementById('fecha').value = '';
        document.getElementById('ubicacion').value = '';
        document.getElementById('estado').value = '';
        document.getElementById('ganador').value = '';
      }

      async function savePelea() {
        const id = document.getElementById('peleaId').value;

        const payload = {
          peleador1_id: parseInt(document.getElementById('peleador1').value),
          peleador2_id: parseInt(document.getElementById('peleador2').value),
          fecha: document.getElementById('fecha').value.replace('T', ' '),
          ubicacion: document.getElementById('ubicacion').value,
          estado: document.getElementById('estado').value || 'pendiente',
          ganador: document.getElementById('ganador').value ? parseInt(document.getElementById('ganador').value) : null
        };

        let res = await fetch(id ? `/peleas/${id}` : '/peleas', {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const body = await res.json();
        const success = body.success === undefined ? (body === true || body === 1) : body.success;

        if (success) {
          modal.hide();
          setTimeout(() => location.reload(), 300);
        } else {
          alert('Error: No se pudo guardar la pelea');
        }
      }

      async function deletePelea(id) {
        if (!confirm('¬øEliminar pelea?')) return;

        let res = await fetch(`/peleas/${id}`, { method: 'DELETE' });
        const body = await res.json();

        if (body.success) location.reload();
        else alert('No se pudo eliminar');
      }
    </script>
  </body>
</html>
