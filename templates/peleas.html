<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Peleas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .btn-edit { background-color: #5A60FF; color: white; }
        .btn-edit:hover { background-color: #4b51d6; }
        .btn-delete { background-color: #E63946; color: white; }
        .btn-delete:hover { background-color: #bf2d38; }
        .table thead { background: #2C2E39; color: white; }
    </style>
</head>

<body class="p-4">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3">Peleas</h1>
        <button class="btn btn-primary" onclick="openAddModal()">Agregar Pelea</button>
    </div>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Peleador 1</th>
                <th>Peleador 2</th>
                <th>Fecha</th>
                <th>Ubicación</th>
                <th>Estado</th>
                <th>Ganador</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>

        {% for p in peleas %}

            {% set peleador1 = peleadores | selectattr("id","eq", p.peleador1_id) | first %}
            {% set peleador2 = peleadores | selectattr("id","eq", p.peleador2_id) | first %}
            {% set ganador = peleadores | selectattr("id","eq", p.ganador) | first %}

            <tr data-id="{{ p.id }}"
                data-peleador1="{{ p.peleador1_id }}"
                data-peleador2="{{ p.peleador2_id }}"
                data-fecha="{{ p.fecha }}"
                data-ubicacion="{{ p.ubicacion }}"
                data-estado="{{ p.estado }}"
                data-ganador="{{ p.ganador }}">

                <td>{{ p.id }}</td>
                <td>{{ peleador1.alias if peleador1 else 'N/A' }}</td>
                <td>{{ peleador2.alias if peleador2 else 'N/A' }}</td>
                <td>{{ p.fecha }}</td>
                <td>{{ p.ubicacion }}</td>
                <td>{{ p.estado }}</td>
                <td>{{ ganador.alias if ganador else 'N/A' }}</td>

                <td>
                    <button class="btn btn-sm btn-edit" onclick="openEditModal('{{ p.id }}')">Editar</button>
                    <button class="btn btn-sm btn-delete" onclick="deletePelea('{{ p.id }}')">Eliminar</button>
                </td>
            </tr>

        {% endfor %}
        </tbody>
    </table>
</div>


<!-- MODAL -->
<div class="modal fade" id="peleaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <form id="peleaForm" onsubmit="event.preventDefault(); savePelea();">

                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Agregar Pelea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="peleaId">

                    <div class="row g-2">

                        <div class="col-md-6">
                            <label class="form-label">Peleador 1</label>
                            <select id="peleador1" class="form-control" required>
                                <option value="">Seleccione...</option>
                                {% for pl in peleadores %}
                                    <option value="{{ pl.id }}">{{ pl.alias }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Peleador 2</label>
                            <select id="peleador2" class="form-control" required>
                                <option value="">Seleccione...</option>
                                {% for pl in peleadores %}
                                    <option value="{{ pl.id }}">{{ pl.alias }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Fecha</label>
                            <input type="datetime-local" id="fecha" class="form-control" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Ubicación</label>
                            <input type="text" id="ubicacion" class="form-control" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Estado</label>
                            <input type="text" id="estado" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Ganador</label>
                            <select id="ganador" class="form-control" required>
                                <option value="">Seleccione...</option>
                                {% for pl in peleadores %}
                                    <option value="{{ pl.id }}">{{ pl.alias }}</option>
                                {% endfor %}
                            </select>
                        </div>

                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>

            </form>

        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

const modalEl = document.getElementById("peleaModal");
const modal = new bootstrap.Modal(modalEl);

// --------------------
// Abrir modal NUEVO
// --------------------
function openAddModal() {
    document.getElementById("modalTitle").textContent = "Agregar Pelea";
    clearForm();
    modal.show();
}

// --------------------
// Abrir modal EDITAR
// --------------------
function openEditModal(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) return;

    document.getElementById("modalTitle").textContent = "Editar Pelea";
    document.getElementById("peleaId").value = id;

    document.getElementById("peleador1").value = row.dataset.peleador1;
    document.getElementById("peleador2").value = row.dataset.peleador2;
    document.getElementById("fecha").value = row.dataset.fecha.replace(" ", "T");
    document.getElementById("ubicacion").value = row.dataset.ubicacion;
    document.getElementById("estado").value = row.dataset.estado;
    document.getElementById("ganador").value = row.dataset.ganador;

    modal.show();
}

// --------------------
// Limpiar formulario
// --------------------
function clearForm() {
    document.getElementById("peleaId").value = "";
    document.getElementById("peleador1").value = "";
    document.getElementById("peleador2").value = "";
    document.getElementById("fecha").value = "";
    document.getElementById("ubicacion").value = "";
    document.getElementById("estado").value = "";
    document.getElementById("ganador").value = "";
}

// --------------------
// Guardar pelea
// --------------------
async function savePelea() {
    const id = document.getElementById("peleaId").value;

    const payload = {
        peleador1_id: parseInt(document.getElementById("peleador1").value),
        peleador2_id: parseInt(document.getElementById("peleador2").value),
        fecha: document.getElementById("fecha").value.replace("T", " "),
        ubicacion: document.getElementById("ubicacion").value,
        estado: document.getElementById("estado").value,
        ganador: parseInt(document.getElementById("ganador").value)
    };

    let res = await fetch(id ? `/peleas/${id}` : "/peleas", {
        method: id ? "PUT" : "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    let body = await res.json();
    let success = body.success === undefined ? body === true : body.success;

    if (success) {
        modal.hide();
        setTimeout(() => location.reload(), 300);
    } else {
        alert("Error: No se pudo guardar la pelea");
    }
}

// --------------------
// Eliminar pelea
// --------------------
async function deletePelea(id) {
    if (!confirm("¿Eliminar pelea?")) return;

    let res = await fetch(`/peleas/${id}`, { method: "DELETE" });
    let body = await res.json();

    if (body.success) location.reload();
    else alert("No se pudo eliminar");
}

</script>

</body>
</html>
